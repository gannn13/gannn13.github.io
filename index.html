<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Efisiensi Charger HP • dSoC/dt</title>
    <meta name="description" content="Mini Riset Kalkulus: Analisis kecepatan charger menggunakan turunan numerik dSoC/dt">

    <!-- Chart.js & MathJax -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #3b82f6;
            --accent: #60a5fa;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(59,130,246,0.4);
            color: white;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #3b82f6;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
        h1 { font-size: 2em; margin: 10px 0; }
        .subtitle { font-size: 1.1em; opacity: 0.9; }

        .container { max-width: 1200px; margin: 0 auto; }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59,130,246,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(59,130,246,0.3); }

        h2 {
            color: var(--accent);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(15,23,42,0.6);
            border-radius: 12px;
            overflow: hidden;
        }
        th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: center;
        }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #334155; }
        input {
            width: 100%;
            padding: 10px;
            border: none;
            background: #1e293b;
            color: white;
            border-radius: 8px;
        }
        input:focus { outline: 2px solid var(--accent); }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        .formula-box {
            background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(96,165,250,0.1));
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--accent);
            margin: 20px 0;
        }
        .math {
            background: rgba(15,23,42,0.8);
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            font-size: 1.2em;
            text-align: center;
            border-left: 5px solid var(--accent);
        }

        canvas {
            border-radius: 12px;
            background: var(--card);
            padding: 15px;
            box-shadow: inset 0 4px 15px rgba(0,0,0,0.3);
        }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 28px;
            box-shadow: 0 8px 25px rgba(59,130,246,0.6);
            z-index: 1000;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59,130,246,0.7); }
            70% { box-shadow: 0 0 0 15px rgba(59,130,246,0); }
            100% { box-shadow: 0 0 0 0 rgba(59,130,246,0); }
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.9em;
            margin-top: 50px;
        }

        @media (max-width: 768px) {
            .card { padding: 18px; }
            button { width:100%; margin:8px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">Battery</div>
            <h1>Analisis Efisiensi Charger HP</h1>
            <p class="subtitle">Menggunakan Turunan Numerik dSoC/dt (%/menit)</p>
        </header>

        <div class="card">
            <h2>Input Data Percobaan</h2>
            <table id="dataTable">
                <thead><tr><th>Waktu (menit)</th><th>SoC (%)</th><th>Aksi</th></tr></thead>
                <tbody>
                    <tr>
                        <td><input type="number" step="0.1" min="0" value="0" required></td>
                        <td><input type="number" min="0" max="100" value="5" required></td>
                        <td><button class="btn-danger">Hapus</button></td>
                    </tr>
                </tbody>
            </table>
            <button class="btn-primary" id="addRow">+ Tambah Baris</button>
            <button class="btn-primary" id="resetTable">Reset</button>
            <button class="btn-primary" id="pasteCSV">Tempel CSV</button>
        </div>

        <div class="card">
            <h2>Teori & Rumus Turunan Numerik</h2>
            <div class="formula-box">
                <div class="math">\[\frac{dSoC}{dt} = \lim_{\Delta t \to 0} \frac{\Delta SoC}{\Delta t}\]</div>
                <p><strong>Forward Difference</strong> (titik awal):</p>
                <div class="math">\[\frac{dSoC}{dt}\bigg|_0 \approx \frac{SoC_1 - SoC_0}{t_1 - t_0}\]</div>
                <p><strong>Backward Difference</strong> (titik akhir):</p>
                <div class="math">\[\frac{dSoC}{dt}\bigg|_n \approx \frac{SoC_n - SoC_{n-1}}{t_n - t_{n-1}}\]</div>
                <p><strong>Central Difference</strong> (titik tengah – paling akurat):</p>
                <div class="math">\[\frac{dSoC}{dt}\bigg|_i \approx \frac{SoC_{i+1} - SoC_{i-1}}{t_{i+1} - t_{i-1}\]</div>
                <p><strong>Skor Efisiensi</strong>:</p>
                <div class="math">\[\text{Skor} = \min(100,\ 10 \times \overline{\frac{dSoC}{dt}})\]</div>
            </div>
            <h3>Langkah Perhitungan Detail</h3>
            <div id="stepByStep" style="background:#1e293b;padding:20px;border-radius:12px;"></div>
        </div>

        <div class="card">
            <h2>Hasil Perhitungan</h2>
            <div id="calculationResults" style="font-size:1.3em; text-align:center; padding:20px; background:rgba(16,185,129,0.2); border-radius:12px;"></div>
        </div>

        <div class="card">
            <h2>Grafik Interaktif</h2>
            <canvas id="socChart"></canvas>
            <canvas id="dsocdtChart"></canvas>
        </div>

        <div class="card">
            <h2>Upload ke Feed Publik</h2>
            <input type="text" id="merkCharger" placeholder="Contoh: Xiaomi 120W Turbo Charger" style="margin:10px 0;">
            <input type="text" id="hpModel" placeholder="Contoh: Xiaomi 14 Pro">
            <button class="btn-success" id="uploadPublic" style="width:100%;padding:15px;font-size:1.1em;">Upload ke Leaderboard Publik</button>
        </div>

        <div class="card">
            <h2>Leaderboard Publik</h2>
            <div id="publicFeed"></div>
        </div>

        <div class="card">
            <h2>Ekspor</h2>
            <button class="btn-primary" id="exportCSV" style="width:48%;">Download CSV</button>
            <button class="btn-primary" id="exportHTML" style="width:48%;">Download Laporan HTML</button>
        </div>
    </div>

    <!-- Floating Button -->
    <button class="floating-btn" id="scrollTop" title="Ke atas">Up Arrow</button>

    <!-- Modal CSV -->
    <div id="csvModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;">
        <div style="background:#1e293b;padding:30px;border-radius:16px;width:90%;max-width:600px;">
            <h2 style="color:white;margin-bottom:20px;">Tempel CSV</h2>
            <textarea id="csvInput" style="width:100%;height:200px;background:#0f172a;color:white;padding:15px;border-radius:10px;"></textarea>
            <button class="btn-primary" id="submitCSV" style="width:100%;margin-top:15px;padding:15px;">Submit</button>
            <button style="position:absolute;top:10px;right:15px;font-size:24px;background:none;border:none;color:white;" id="closeModal">×</button>
        </div>
    </div>

    <footer>
        <p>Mini Riset Kalkulus Diferensial • 2025 | Dibuat dengan ❤️ & JavaScript Murni</p>
        <p>Hosted Gratis di <strong>GitHub Pages</strong></p>
    </footer>

    <script>
        const dataTable = document.querySelector('#dataTable tbody');
        const addRow = document.getElementById('addRow');
        const resetTable = document.getElementById('resetTable');
        const pasteCSV = document.getElementById('pasteCSV');
        const modal = document.getElementById('csvModal');
        const closeModal = document.getElementById('closeModal');
        const submitCSV = document.getElementById('submitCSV');
        const csvInput = document.getElementById('csvInput');
        const stepByStep = document.getElementById('stepByStep');
        const results = document.getElementById('calculationResults');
        const uploadBtn = document.getElementById('uploadPublic');
        const merk = document.getElementById('merkCharger');
        const hp = document.getElementById('hpModel');
        const feed = document.getElementById('publicFeed');

        let chart1, chart2;

        // Tambah & Hapus Baris
        addRow.onclick = () => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="number" step="0.1" min="0"></td>
                            <td><input type="number" min="0" max="100"></td>
                            <td><button class="btn-danger">Hapus</button></td>`;
            dataTable.appendChild(tr);
            tr.querySelectorAll('button')[0].onclick = () => { tr.remove(); calc(); };
        };

        document.querySelectorAll('.btn-danger').forEach(b => {
            b.onclick = () => { b.closest('tr').remove(); calc(); };
        });

        resetTable.onclick = () => location.reload();

        // CSV Modal
        pasteCSV.onclick = () => modal.style.display = 'flex';
        closeModal.onclick = closeModal.onclick = () => modal.style.display = 'none';
        submitCSV.onclick = () => {
            dataTable.innerHTML = '';
            csvInput.value.trim().split('\n').forEach(line => {
                const [t, soc] = line.split(',').map(Number);
                if (!isNaN(t) && !isNaN(soc)) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><input type="number" step="0.1" value="${t}"></td>
                                    <td><input type="number" value="${soc}"></td>
                                    <td><button class="btn-danger">Hapus</button></td>`;
                    dataTable.appendChild(tr);
                    tr.querySelector('button').onclick = () => { tr.remove(); calc(); };
                }
            });
            modal.style.display = 'none';
            calc();
        };

        function getData() {
            const data = [];
            dataTable.querySelectorAll('tr').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const t = parseFloat(inputs[0].value);
                const soc = parseFloat(inputs[1].value);
                if (!isNaN(t) && !isNaN(soc)) data.push({t, soc});
            });
            return data.sort((a,b)=>a.t-b.t);
        }

        function calc() {
            const data = getData();
            if (data.length < 2) { results.innerHTML = "Masukkan minimal 2 titik!"; return; }

            const rates = [];
            const steps = [];

            for (let i = 0; i < data.length; i++) {
                let rate, tex;
                if (i === 0) {
                    rate = (data[1].soc - data[0].soc)/(data[1].t - data[0].t);
                    tex = `Forward: \\frac{${data[1].soc} - ${data[0].soc}}{${data[1].t} - ${data[0].t}} = ${rate.toFixed(3)}`;
                } else if (i === data.length-1) {
                    rate = (data[i].soc - data[i-1].soc)/(data[i].t - data[i-1].t);
                    tex = `Backward: \\frac{${data[i].soc} - ${data[i-1].soc}}{${data[i].t} - ${data[i-1].t}} = ${rate.toFixed(3)}`;
                } else {
                    rate = (data[i+1].soc - data[i-1].soc)/(data[i+1].t - data[i-1].t);
                    tex = `Central: \\frac{${data[i+1].soc} - ${data[i-1].soc}}{${data[i+1].t} - ${data[i-1].t}} = ${rate.toFixed(3)}`;
                }
                rates.push(rate);
                steps.push(tex);
            }

            const avg = rates.reduce((a,b)=>a+b,0)/rates.length;
            skor = Math.min(100, avg*10).toFixed(1);

            results.innerHTML = `<strong style="color:#10b981;font-size:2em;">${avg.toFixed(3)} %/menit</strong><br>
                                 <span style="font-size:1.4em;color:#60a5fa;">Skor Efisiensi: ${skor}/100 span>`;

            stepByStep.innerHTML = '<ol style="line-height:2;">' + steps.map(s=>`<li>${s}</li>`).join('') + '</ol>';
            MathJax.typesetPromise();

            // Grafik
            const labels = data.map(d=>d.t);
            if(chart1) chart1.destroy();
            if(chart2) chart2.destroy();

            chart1 = new Chart(document.getElementById('socChart'), {type:'line', data:{labels, datasets:[{label:'SoC (%)', data:data.map(d=>d.soc), borderColor:'#60a5fa', tension:0.4, fill:true}]}, options:{responsive:true}});
            chart2 = new Chart(document.getElementById('dsocdtChart'), {type:'line', data:{labels, datasets:[{label:'dSoC/dt', data:rates, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.3)', fill:true}]}, options:{responsive:true}});
        }

        // Ekspor
        document.getElementById('exportCSV').onclick = () => {
            let csv = "Waktu,SoC\n" + getData().map(d=>`${d.t},${d.soc}`).join("\n");
            download(csv, "data_charger.csv", "text/csv");
        };
        document.getElementById('exportHTML').onclick = () => {
            const {avg, skor} = calc() || {};
            const html = `<!DOCTYPE html><html><head><title>Laporan Charger</title></head><body style="font-family:sans-serif;padding:40px;background:#0f172a;color:white;">
                <h1 style="color:#60a5fa">Laporan Efisiensi Charger</h1>
                <p>Rata-rata: ${avg?.toFixed(3)} %/menit | Skor: ${skor}/100</p>
                <table border="1" style="width:100%;border-collapse:collapse;"><tr><th>Waktu</th><th>SoC</th></tr>
                ${getData().map(d=>`<tr><td>${d.t}</td><td>${d.soc}</td></tr>`).join('')}</table></body></html>`;
            download(html, "laporan.html", "text/html");
        };
        function download(text, name, type) {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([text], {type}));
            a.download = name;
            a.click();
        }

        // Leaderboard
        uploadBtn.onclick = () => {
            calc();
            if (!merk.value || !hp.value) return alert("Isi merk & HP dulu!");
            const entry = {merk:merk.value, hp:hp.value, avg:avg.toFixed(3), skor, time:new Date().toLocaleString('id-ID')};
            let list = JSON.parse(localStorage.getItem('chargerLeaderboard')||'[]');
            list.unshift(entry);
            localStorage.setItem('chargerLeaderboard', JSON.stringify(list));
            loadLeaderboard();
        };
        function loadLeaderboard() {
            const list = JSON.parse(localStorage.getItem('chargerLeaderboard')||'[]');
            feed.innerHTML = list.length ? `<table style="width:100%;text-align:left;">
                <tr style="background:#3b82f6;color:white;"><th>Charger</th><th>HP</th><th>dSoC/dt</th><th>Skor</th><th>Waktu</th></tr>
                ${list.map(e=>`<tr><td>${e.merk}</td><td>${e.hp}</td><td>${e.avg}</td><td><strong>${e.skor}</strong></td><td>${e.time}</td></tr>`).join('')}
                </table>` : "<p style='text-align:center;color:#94a3b8;'>Belum ada data publik</p>";
        }
        loadLeaderboard();

        // Scroll to top
        document.getElementById('scrollTop').onclick = () => window.scrollTo({top:0, behavior:'smooth'});

        dataTable.addEventListener('input', calc);
        calc();
    </script>
</body>
</html>
